---
const navItems = [
  { label: 'Home', href: '/' },
  { label: 'About Us', href: '/#aboutUs' },
  { label: 'Initiatives', href: '/#initiatives', hasSubmenu: 'initiatives' },
  { label: 'Events', href: '/#events' },
  { label: 'Partners', href: '/partners' },
  { label: 'Event Space', href: '/event-space', hasSubmenu: 'eventSpace' },
  { label: 'Contact Us', href: '/contact' },
];

const initiatives = [
  { label: 'Public Service', href: '/initiatives/public-service' },
  { label: 'Civic Leadership', href: '/initiatives/civic-leadership' },
  { label: 'Citizenship & Tech', href: '/initiatives/citizenship-tech' },
];

const eventSpaceOptions = [
  { label: 'Explore Our Space', href: '/event-space' },
  { label: 'Reserve Event Space', href: '/book-event-space' },
];

const currentPath = Astro.url.pathname;
const isInitiativePage = currentPath.startsWith('/initiatives/');
const isEventSpacePage = currentPath === '/event-space' || currentPath === '/book-event-space';
const isBookEventSpacePage = currentPath === '/book-event-space';
---

<header class="sticky top-0 z-50 bg-white shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
      <a href="/" class="flex-shrink-0">
        <img
          src="/images/logos/logo-color.png"
          alt="CGCS Logo"
          class="h-20 md:h-24 w-auto"
        />
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center space-x-8">
        {navItems.map((item) => (
          <a
            href={item.href}
            data-nav-item
            data-section={item.href.includes('#') ? item.href.split('#')[1] : (item.href === '/' ? 'home' : '')}
            class:list={[
              'text-sm font-medium transition-colors hover:text-primary nav-link',
              (currentPath === '/' && item.href === '/')
                ? 'text-primary border-b-2 border-primary'
                : (isInitiativePage && item.label === 'Initiatives')
                  ? 'text-primary border-b-2 border-primary'
                  : (isBookEventSpacePage && item.label === 'Event Space')
                    ? 'text-primary border-b-2 border-primary'
                    : (currentPath === '/event-space' && item.label === 'Event Space')
                      ? 'text-primary'
                      : (currentPath === item.href)
                        ? 'text-primary'
                        : 'text-text-dark'
            ]}
          >
            {item.label}
          </a>
        ))}
      </nav>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-btn"
        class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
        aria-label="Toggle menu"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Fullscreen Mobile Menu Overlay -->
<div id="mobile-menu-overlay" class="mobile-menu-overlay">
  <!-- Logo at top left -->
  <a href="/" class="mobile-menu-logo">
    <img
      src="/images/logos/logo-color.png"
      alt="CGCS Logo"
      class="h-20 w-auto"
    />
  </a>

  <button id="mobile-menu-close" class="mobile-menu-close" aria-label="Close menu">
    &times;
  </button>

  <nav class="mobile-menu-nav">
    {navItems.map((item) => (
      item.hasSubmenu === 'initiatives' ? (
        <div class="mobile-menu-accordion">
          <button class="mobile-menu-item accordion-trigger" data-accordion="initiatives" data-mobile-nav-item data-section="initiatives">
            <span>{item.label}</span>
            <svg class="accordion-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="accordion-content" id="initiatives-submenu">
            {initiatives.map((sub) => (
              <a
                href={sub.href}
                class:list={[
                  'mobile-submenu-item',
                  currentPath === sub.href ? 'text-primary' : ''
                ]}
              >
                {sub.label}
              </a>
            ))}
          </div>
        </div>
      ) : item.hasSubmenu === 'eventSpace' ? (
        <div class="mobile-menu-accordion">
          <button class="mobile-menu-item accordion-trigger" data-accordion="eventSpace">
            <span>{item.label}</span>
            <svg class="accordion-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="accordion-content" id="eventSpace-submenu">
            {eventSpaceOptions.map((sub) => (
              <a
                href={sub.href}
                class:list={[
                  'mobile-submenu-item',
                  currentPath === sub.href ? 'text-primary' : ''
                ]}
              >
                {sub.label}
              </a>
            ))}
          </div>
        </div>
      ) : (
        <a
          href={item.href}
          data-mobile-nav-item
          data-section={item.href.includes('#') ? item.href.split('#')[1] : (item.href === '/' ? 'home' : '')}
          class:list={[
            'mobile-menu-item',
            (currentPath === '/' && item.href === '/') ? 'text-primary' :
            (currentPath === item.href) ? 'text-primary' : ''
          ]}
        >
          {item.label}
        </a>
      )
    ))}
  </nav>
</div>

<style>
  .mobile-menu-overlay {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 100;
    display: none;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.2s ease-out;
  }

  .mobile-menu-overlay.open {
    display: flex;
    opacity: 1;
  }

  .mobile-menu-logo {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 101;
  }

  .mobile-menu-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 3.5rem;
    height: 3.5rem;
    border: none;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 50%;
    font-size: 2rem;
    font-weight: 300;
    cursor: pointer;
    z-index: 101;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.2s;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
  }

  .mobile-menu-close:hover {
    background: white;
    transform: scale(1.1);
  }

  .mobile-menu-nav {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    height: 100%;
    gap: 0;
    padding: 7rem 1.5rem 2rem;
    overflow-y: auto;
  }

  .mobile-menu-item {
    font-size: 1.15rem;
    font-weight: 600;
    color: #1a1a1a;
    text-decoration: none;
    padding: 0.875rem 1.5rem;
    width: 100%;
    text-align: center;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
  }

  .mobile-menu-item:hover,
  .mobile-menu-item.text-primary {
    color: #00A651;
  }

  .mobile-menu-accordion {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .accordion-trigger {
    font-family: inherit;
  }

  .accordion-chevron {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s;
  }

  .accordion-trigger[aria-expanded="true"] .accordion-chevron {
    transform: rotate(180deg);
  }

  .accordion-content {
    display: none;
    flex-direction: column;
    width: 100%;
    background: #f9fafb;
    border-radius: 1rem;
    margin: 0.5rem 0;
    overflow: hidden;
  }

  .accordion-content.open {
    display: flex;
  }

  .mobile-submenu-item {
    font-size: 1rem;
    font-weight: 500;
    color: #4b5563;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    text-align: center;
    transition: color 0.2s, background 0.2s;
  }

  .mobile-submenu-item:hover,
  .mobile-submenu-item.text-primary {
    color: #00A651;
    background: rgba(0, 166, 81, 0.05);
  }

  /* Hide body scroll when menu is open */
  body:has(.mobile-menu-overlay.open) {
    overflow: hidden;
  }
</style>

<script>
  const menuBtn = document.getElementById('mobile-menu-btn');
  const menuOverlay = document.getElementById('mobile-menu-overlay');
  const closeBtn = document.getElementById('mobile-menu-close');
  const accordionTriggers = document.querySelectorAll('.accordion-trigger');

  // Open menu
  menuBtn?.addEventListener('click', () => {
    menuOverlay?.classList.add('open');
  });

  // Close menu
  closeBtn?.addEventListener('click', () => {
    menuOverlay?.classList.remove('open');
    // Also close all accordions
    accordionTriggers.forEach((trigger) => {
      trigger.setAttribute('aria-expanded', 'false');
      const accordionId = trigger.getAttribute('data-accordion');
      const content = document.getElementById(`${accordionId}-submenu`);
      content?.classList.remove('open');
    });
  });

  // Close menu when clicking a link (except accordion trigger)
  menuOverlay?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      menuOverlay?.classList.remove('open');
    });
  });

  // Accordion toggle for each trigger
  accordionTriggers.forEach((trigger) => {
    trigger.addEventListener('click', () => {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
      const accordionId = trigger.getAttribute('data-accordion');
      const content = document.getElementById(`${accordionId}-submenu`);

      trigger.setAttribute('aria-expanded', String(!isExpanded));
      content?.classList.toggle('open');
    });
  });

  // Scroll-based active navigation (desktop and mobile)
  const sections = ['aboutUs', 'initiatives', 'events'];
  const navLinks = document.querySelectorAll('[data-nav-item]');
  const mobileNavLinks = document.querySelectorAll('[data-mobile-nav-item]');

  function setActiveNav(sectionId: string | null) {
    // Update desktop nav
    navLinks.forEach((link) => {
      const linkSection = link.getAttribute('data-section');
      link.classList.remove('text-primary', 'border-b-2', 'border-primary');
      link.classList.add('text-text-dark');

      if (sectionId === null || sectionId === 'home') {
        if (linkSection === 'home') {
          link.classList.remove('text-text-dark');
          link.classList.add('text-primary', 'border-b-2', 'border-primary');
        }
      } else if (linkSection === sectionId) {
        link.classList.remove('text-text-dark');
        link.classList.add('text-primary');
      }
    });

    // Update mobile nav
    mobileNavLinks.forEach((link) => {
      const linkSection = link.getAttribute('data-section');
      link.classList.remove('text-primary');

      if (sectionId === null || sectionId === 'home') {
        if (linkSection === 'home') {
          link.classList.add('text-primary');
        }
      } else if (linkSection === sectionId) {
        link.classList.add('text-primary');
      }
    });
  }

  // Only run on homepage
  if (window.location.pathname === '/') {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            setActiveNav(entry.target.id);
          }
        });
      },
      { threshold: 0.3, rootMargin: '-100px 0px -50% 0px' }
    );

    sections.forEach((sectionId) => {
      const section = document.getElementById(sectionId);
      if (section) observer.observe(section);
    });

    window.addEventListener('scroll', () => {
      if (window.scrollY < 200) {
        setActiveNav('home');
      }
    });

    if (window.scrollY < 200) {
      setActiveNav('home');
    }
  }
</script>
